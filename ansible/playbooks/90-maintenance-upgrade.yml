---
- name: Maintenance - OS upgrade (dist-upgrade) + reboot if needed
  hosts: all
  become: true
  gather_facts: true

  vars:
    maintenance_reboot_if_required: true

  tasks:
    - name: Wait for any unattended/dpkg locks to clear (best effort)
      shell: |
        set -e
        for i in $(seq 1 30); do
          if fuser /var/lib/dpkg/lock >/dev/null 2>&1; then
            sleep 2
            continue
          fi
          if fuser /var/lib/dpkg/lock-frontend >/dev/null 2>&1; then
            sleep 2
            continue
          fi
          exit 0
        done
        exit 0
      args:
        executable: /bin/bash
      changed_when: false

    - name: Update apt cache
      apt:
        update_cache: yes
      register: apt_update
      retries: 6
      delay: 10
      until: apt_update is succeeded

    - name: Dist-upgrade packages
      apt:
        upgrade: dist
      register: apt_upgrade
      retries: 3
      delay: 20
      until: apt_upgrade is succeeded

    - name: Autoremove unused packages
      apt:
        autoremove: yes

    - name: Check if reboot is required
      stat:
        path: /var/run/reboot-required
      register: reboot_required

    - name: Reboot if required (maintenance mode)
      reboot:
        msg: "Reboot initiated by PathOps maintenance upgrade playbook"
        reboot_timeout: 900
      when: maintenance_reboot_if_required and reboot_required.stat.exists

    - name: Verify system is back
      wait_for_connection:
        timeout: 300