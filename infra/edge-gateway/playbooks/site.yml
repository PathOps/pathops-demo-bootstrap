---
- name: Public Edge Gateway - DO Droplet
  hosts: edge_gateway
  become: true

  vars_files:
    - ../group_vars/edge_gateway.yml
    - ../group_vars/edge_gateway_vault.yml

  vars:
    cert_name: "{{ domain_apex }}"
    le_live_dir: "/etc/letsencrypt/live/{{ cert_name }}"
    do_creds_path: "/root/.secrets/certbot/digitalocean.ini"

  tasks:

  # -----------------------------
  # System Hardening
  # -----------------------------

    - name: Ensure system updated
      apt:
        update_cache: yes
        upgrade: dist

    - name: Install base packages
      apt:
        name:
          - nginx
          - certbot
          - python3-certbot-dns-digitalocean
          - ufw
        state: present
    
    - name: Configure UFW default deny
      ufw:
        state: enabled
        policy: deny

    - name: Allow required ports
      ufw:
        rule: allow
        port: "{{ item }}"
      loop: "{{ ufw_allowed_ports }}"

  # -----------------------------
  # Certbot DNS-01
  # -----------------------------

    - name: Create certbot secrets dir
      file:
        path: "{{ do_creds_path | dirname }}"
        state: directory
        mode: "0700"

    - name: Write DO DNS credentials
      copy:
        dest: "{{ do_creds_path }}"
        content: |
          dns_digitalocean_token = {{ do_dns_token }}
        mode: "0600"

    - name: Obtain or renew wildcard certificate
      command: >
        certbot certonly
        --cert-name {{ domain_apex }}
        --non-interactive --agree-tos
        --email {{ letsencrypt_email }}
        --dns-digitalocean
        --dns-digitalocean-credentials {{ do_creds_path }}
        -d {{ domain_apex }}
        -d {{ domain_wildcard }}
        --keep-until-expiring
      register: certbot_out
      changed_when: "'Congratulations' in certbot_out.stdout"
      failed_when: certbot_out.rc != 0

  # -----------------------------
  # NGINX CONFIG
  # -----------------------------

    - name: Install nginx gateway config
      copy:
        dest: /etc/nginx/sites-available/pathops-edge.conf
        mode: "0644"
        content: |
          server {
            listen 80;
            server_name {{ domain_apex }} *.{{ domain_apex }};
            return 301 https://$host$request_uri;
          }

          server {
              listen 443 ssl http2;
              server_name edge.{{ domain_apex }};

              ssl_certificate     {{ le_live_dir }}/fullchain.pem;
              ssl_certificate_key {{ le_live_dir }}/privkey.pem;

              ssl_protocols TLSv1.2 TLSv1.3;

              location / {
                  default_type text/plain;
                  return 200 "PathOps Public Edge Gateway OK\n";
              }
          }

          server {
            listen 443 ssl http2;
            server_name {{ domain_apex }} *.{{ domain_apex }};

            ssl_certificate     {{ le_live_dir }}/fullchain.pem;
            ssl_certificate_key {{ le_live_dir }}/privkey.pem;

            ssl_protocols TLSv1.2 TLSv1.3;
            ssl_prefer_server_ciphers off;

            ssl_session_cache shared:SSL:10m;
            ssl_session_timeout 10m;

            # HSTS (si querés; para demo lo podés dejar)
            add_header Strict-Transport-Security "max-age=31536000" always;

            client_max_body_size 0;

            resolver 1.1.1.1 8.8.8.8 valid=10s ipv6=off;

            proxy_set_header Host              $host;
            proxy_set_header X-Real-IP         $remote_addr;
            proxy_set_header X-Forwarded-For   $proxy_add_x_forwarded_for;
            proxy_set_header X-Forwarded-Proto https;

            proxy_connect_timeout 60s;
            proxy_read_timeout    600s;
            proxy_send_timeout    600s;

            proxy_http_version 1.1;
            proxy_set_header Upgrade    $http_upgrade;
            proxy_set_header Connection "upgrade";

            location / {
              set $backend "{{ backend_host }}";
              proxy_pass {{ backend_scheme }}://$backend:{{ backend_port }};

              {% if backend_scheme == "https" %}
              proxy_ssl_server_name on;
              {% if backend_tls_insecure %}
              proxy_ssl_verify off;
              {% endif %}
              {% endif %}
            }
          }
      notify: Reload nginx

    - name: Enable nginx site
      file:
        src: /etc/nginx/sites-available/pathops-edge.conf
        dest: /etc/nginx/sites-enabled/pathops-edge.conf
        state: link
        force: yes

    - name: Disable default nginx site
      file:
        path: /etc/nginx/sites-enabled/default
        state: absent
      ignore_errors: yes

    - name: Validate nginx config
      command: nginx -t
      changed_when: false

    - name: Ensure certbot auto-renew timer enabled
      systemd:
        name: certbot.timer
        enabled: yes
        state: started

    - name: Add renewal hook to reload nginx
      copy:
        dest: /etc/letsencrypt/renewal-hooks/deploy/reload-nginx.sh
        mode: "0755"
        content: |
          #!/bin/bash
          systemctl reload nginx

  handlers:
    - name: Reload nginx
      service:
        name: nginx
        state: reloaded
