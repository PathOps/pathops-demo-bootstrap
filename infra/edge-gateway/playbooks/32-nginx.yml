---
- name: Edge Gateway - NGINX (TLS + reverse proxy)
  hosts: edge_gateway
  become: true

  vars_files:
    - ../group_vars/edge_gateway.yml
    - ../group_vars/edge_gateway_vault.yml

  vars:
    cert_name: "{{ domain_apex }}"
    le_live_dir: "/etc/letsencrypt/live/{{ cert_name }}"

  tasks:
    - name: Install nginx gateway config
      copy:
        dest: /etc/nginx/sites-available/pathops-edge.conf
        mode: "0644"
        content: |
          server {
            listen 80;
            server_name {{ domain_apex }} *.{{ domain_apex }};
            return 301 https://$host$request_uri;
          }

          server {
              listen 443 ssl http2;
              server_name edge.{{ domain_apex }};

              ssl_certificate     {{ le_live_dir }}/fullchain.pem;
              ssl_certificate_key {{ le_live_dir }}/privkey.pem;

              ssl_protocols TLSv1.2 TLSv1.3;

              location / {
                  default_type text/plain;
                  return 200 "PathOps Public Edge Gateway OK\n";
              }
          }

          server {
            listen 443 ssl http2;
            server_name {{ domain_apex }} *.{{ domain_apex }};

            ssl_certificate     {{ le_live_dir }}/fullchain.pem;
            ssl_certificate_key {{ le_live_dir }}/privkey.pem;

            ssl_protocols TLSv1.2 TLSv1.3;

            add_header Strict-Transport-Security "max-age=31536000" always;

            client_max_body_size 0;

            proxy_set_header Host              $host;
            proxy_set_header X-Real-IP         $remote_addr;
            proxy_set_header X-Forwarded-For   $proxy_add_x_forwarded_for;
            proxy_set_header X-Forwarded-Proto https;

            proxy_connect_timeout 60s;
            proxy_read_timeout    600s;
            proxy_send_timeout    600s;

            proxy_http_version 1.1;
            proxy_set_header Upgrade    $http_upgrade;
            proxy_set_header Connection "upgrade";

            location / {
              set $backend "{{ backend_host }}";
              proxy_pass {{ backend_scheme }}://$backend:{{ backend_port }};
              
              {% if backend_tls_insecure %}
              proxy_ssl_server_name on;
              proxy_ssl_verify off;
              {% endif %}
            }
          }
      notify: Reload nginx

    - name: Enable nginx site
      file:
        src: /etc/nginx/sites-available/pathops-edge.conf
        dest: /etc/nginx/sites-enabled/pathops-edge.conf
        state: link
        force: yes

    - name: Disable default nginx site
      file:
        path: /etc/nginx/sites-enabled/default
        state: absent
      ignore_errors: yes

    - name: Validate nginx config
      command: nginx -t
      changed_when: false

    - name: Ensure nginx enabled and started
      systemd:
        name: nginx
        enabled: yes
        state: started

  handlers:
    - name: Reload nginx
      service:
        name: nginx
        state: reloaded