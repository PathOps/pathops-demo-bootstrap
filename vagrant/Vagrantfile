# vagrant/Vagrantfile
require "yaml"
require "erb"

cfg = YAML.load_file(File.join(__dir__, "config", "vms.yml"))

Vagrant.configure("2") do |config|
  config.vm.box = cfg.dig("project", "ubuntu_box") || "bento/ubuntu-24.04"
  config.vm.synced_folder "..", "/vagrant", disabled: true

  cfg["vms"].each do |vm|
    config.vm.define vm["name"] do |node|
      node.vm.hostname = vm["hostname"]

      # NIC1: NAT (default) - internet
      # NIC2: Host-only with fixed IP
      node.vm.network "private_network",
        ip: vm["ip"],
        virtualbox__intnet: false

      node.vm.provider "virtualbox" do |vb|
        vb.name = vm["name"]
        vb.cpus = vm["cpus"] || 2
        vb.memory = vm["memory"] || 2048
      end

      # Bootstrap m√≠nimo para que Ansible pueda entrar y para fijar netplan estable
      node.vm.provision "shell", inline: <<-SHELL
        set -euxo pipefail
        sudo apt-get update -y
        sudo apt-get install -y python3 python3-apt ca-certificates curl
        # opcional: deshabilitar prompt de cloud-init y asegurar hostname
        echo "#{vm["hostname"]}" | sudo tee /etc/hostname
      SHELL
    end
  end
end